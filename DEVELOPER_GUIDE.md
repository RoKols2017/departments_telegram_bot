# Руководство разработчика Telegram-бота

## Содержание
1. [Архитектура проекта](#архитектура-проекта)
2. [Алгоритмы и процессы](#алгоритмы-и-процессы)
3. [Команды бота](#команды-бота)
4. [База данных](#база-данных)
5. [Безопасность](#безопасность)
6. [Планировщик задач](#планировщик-задач)
7. [Разработка и тестирование](#разработка-и-тестирование)

## Архитектура проекта

### Основные компоненты
- **bot.py**: Точка входа, инициализация бота и диспетчера
- **models.py**: Модели данных SQLAlchemy
- **database.py**: Конфигурация базы данных
- **scheduler.py**: Планировщик задач
- **config.py**: Конфигурация приложения
- **handlers/**: Обработчики команд
- **services/**: Бизнес-логика
- **utils/**: Вспомогательные функции
- **keyboards/**: Клавиатуры Telegram

### Взаимодействие компонентов
1. `bot.py` инициализирует приложение и регистрирует обработчики
2. Обработчики в `handlers/` принимают команды и вызывают сервисы
3. Сервисы в `services/` содержат бизнес-логику и работают с БД
4. `scheduler.py` управляет периодическими задачами
5. `utils/` предоставляет общие функции для всех компонентов

## Алгоритмы и процессы

### Регистрация пользователя
1. Пользователь отправляет команду `/start`
2. Проверяется существование пользователя в БД
3. Если пользователь новый:
   - Запрашивается табельный номер
   - Проверяется наличие в базе сотрудников
   - Создается запись в таблице пользователей
   - Назначается базовая роль
4. Отправляется приветственное сообщение

### Создание сбора
1. Администратор выбирает тип сбора (ДР/событие)
2. Указывает детали:
   - Название
   - Сумма
   - Дедлайн
   - Казначей
3. Система:
   - Создает запись в таблице сборов
   - Отправляет уведомление казначею
   - Создает рассылку участникам

### Процесс сбора средств
1. Казначей отмечает поступление средств через `/add_donation`
2. Система:
   - Записывает взнос в БД
   - Обновляет общую сумму сбора
   - Отправляет подтверждение
3. Планировщик периодически проверяет:
   - Приближение дедлайна
   - Наличие неоплативших участников

### Система уведомлений
1. Планировщик регулярно проверяет:
   - Предстоящие дни рождения
   - Дедлайны сборов
   - Неоплаченные взносы
2. Создаются уведомления в БД
3. Отправляются сообщения пользователям

## Команды бота

### Процесс обработки команд
1. Пользователь отправляет команду
2. Middleware проверяет:
   - Права доступа
   - Частоту запросов
   - Валидность данных
3. Вызывается соответствующий обработчик
4. Выполняется бизнес-логика
5. Отправляется ответ пользователю

### Основные команды и их логика

#### Пользовательские команды
- `/start`: Регистрация/авторизация
- `/menu`: Показ главного меню
- `/mydata`: Просмотр личных данных
- `/birthdays`: Список именинников
- `/active_funds`: Активные сборы
- `/my_donations`: История взносов

#### Команды казначея
- `/add_donation`: Учет взноса
  1. Запрос суммы
  2. Выбор участника
  3. Подтверждение
  4. Запись в БД
  
- `/fund_status`: Статус сбора
  1. Выбор сбора
  2. Подсчет собранной суммы
  3. Формирование списка участников
  
- `/remind_unpaid`: Напоминания
  1. Выбор сбора
  2. Определение неоплативших
  3. Отправка напоминаний

#### Команды администратора
- `/add_staff`: Добавление сотрудника
  1. Запрос данных
  2. Валидация
  3. Создание записи
  
- `/create_fund`: Создание сбора
  1. Выбор типа
  2. Ввод параметров
  3. Назначение казначея
  4. Создание записи
  
- `/broadcast`: Рассылка
  1. Ввод текста
  2. Выбор получателей
  3. Отправка сообщений

## База данных

### Основные таблицы
- `users`: Пользователи системы
- `roles`: Роли пользователей
- `funds`: Сборы средств
- `donations`: Взносы
- `notifications`: Уведомления

### Связи между таблицами
- User -> Roles (Many-to-Many)
- Fund -> User (казначей)
- Donation -> Fund, User
- Notification -> User

## Безопасность

### Механизмы защиты
1. Middleware для защиты от спама
2. Система ролей и прав
3. Валидация входных данных
4. Логирование действий

### Обработка ошибок
1. Перехват исключений
2. Логирование в файл
3. Информативные сообщения пользователю

## Планировщик задач

### Основные задачи
1. Проверка дней рождения
2. Контроль дедлайнов
3. Напоминания о взносах
4. Отправка рассылок

### Алгоритм работы
1. Инициализация при старте бота
2. Периодическая проверка условий
3. Создание уведомлений
4. Отправка сообщений

## Разработка и тестирование

### Настройка окружения
1. Клонирование репозитория
2. Установка зависимостей
3. Настройка .env файла
4. Инициализация БД

### Запуск тестов
```bash
pytest tests/
```

### Линтинг кода
```bash
flake8
black .
isort .
```

### Миграции базы данных
```bash
alembic revision --autogenerate -m "description"
alembic upgrade head
```

### Логирование
- Все действия логируются в `logs/`
- Ошибки записываются отдельно
- Действия пользователей отслеживаются

### Рекомендации по разработке
1. Следовать структуре проекта
2. Использовать типизацию
3. Документировать код
4. Писать тесты
5. Проверять безопасность 